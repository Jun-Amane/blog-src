console.log("This site was generated by Hugo.");

document.addEventListener("DOMContentLoaded", () => {
  const cdnBase = "https://cdn.zzy040330.moe";

  /** 判断是否为站内“相对或根路径”资源 */
  const isLocalPath = (url) => {
    return (
      !/^https?:\/\//i.test(url) && !/^\/\//.test(url) && !url.includes(cdnBase)
    );
  };

  /** 将任意相对路径转为以站点根目录为基准的 pathname */
  const toAbsolutePath = (src) => new URL(src, location.href).pathname;

  /** 处理一个 Element（<img> 或其他）指定属性 */
  const handleEl = (el, attr) => {
    const originalSrc = el.getAttribute(attr);
    if (!originalSrc || !isLocalPath(originalSrc)) return;

    const absPath = toAbsolutePath(originalSrc); // /images/xxx.png
    const cdnUrl = cdnBase + absPath; // https://cdn.../images/xxx.png

    // 预加载测试 CDN 是否可用
    const tester = new Image();
    tester.onload = () => el.setAttribute(attr, cdnUrl);
    // onerror 留空即可保留原地址
    tester.src = cdnUrl;
  };

  /** 扫描需要替换的标签 */
  document.querySelectorAll("img").forEach((img) => handleEl(img, "src"));
  document
    .querySelectorAll("img[data-src]")
    .forEach((img) => handleEl(img, "data-src")); // 懒加载支持
});
